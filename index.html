<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>dojo.sensor.geolocation - Example Site</title>
		<script type="text/javascript" src="dojo/dojo.js"></script>
		<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
		
		<style>
        .error{
            color: red;
            }
        .success{
            color: green;
            }
        </style>
    </head>
    <body>
    	
        <div id="status">Determining current location...</div>
      	<div id="coordinates"><span id="latitude"></span>, <span id="longitude"></span></div>
      	<div id="map_canvas" style="width:600px; height:600px"></div>
		
		
		<script type="text/javascript">

			dojo.require("dojo.sensor.geolocation");
			dojo.addOnLoad(function(){
				
				var options = {
					enableHighAccuracy: true,
					timeout: 10000,
					maximumAge: Infinity
				}
				
				var watch_id = dojo.sensor.geolocation.watchPosition(function(position, supported){
					console.log('watching it');
				},function(error, browser_support){
					handle_error(error, browser_support);
				},
				options);
				console.log(watch_id);
				
				
				//Define a default position object to use if browser is unsuported
				var pos = {
					coords: {
						latitude: 41.1603,
						longitude: -80.1225,
						altitude: null,
						accuracy: null,
						altitude_accuracy: null,
						heading: null, // North
						speed: 0 // Not moving
					},
					timestamp: null
				};
				
				
				dojo.sensor.geolocation.getPosition(function(position, unsupported){
					if( unsupported ){
	                    handle_error(null, false);
	                }
	                else{
	                    var status = dojo.byId("status");
	                    dojo.addClass(status, "success");
	                    status.innerHTML = "Found your position";
	                }
	                var coords = position.coords;
	                dojo.byId("latitude").innerHTML = coords.latitude;
	                dojo.byId("longitude").innerHTML = coords.longitude;
	
	                if( coords.accuracy ){
	                    var miles = metersToMiles(coords.accuracy);
	                    if( miles < .25 ){
	                        miles = coords.accuracy; // use Meters
	                    }
	                    dojo.byId("coordinates").innerHTML += "<br />This position has an estimated accuracy of " + miles + " miles.";
	                }
	
	                if( coords.altitude ){
	                    dojo.byId("coordinates").innerHTML += "<br />This position has an altitude of " + coords.altitude + " meters.";
	                }
	
	
	                // Load Google Map
	                var latlng = new google.maps.LatLng(coords.latitude, coords.longitude);
	                var myOptions = {
	                  zoom: 10,
	                  center: latlng,
	                  mapTypeId: google.maps.MapTypeId.ROADMAP
	                };
	                var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
	
	                var marker = new google.maps.Marker({
	                    position: latlng,
	                    map: map,
	                    title: "Your Location"
	                });
				},
				function(error, browser_support){
					handle_error(error, browser_support);
				},
				options,
				pos);
				
			});
			
			function handle_error(error, browser_support){
                var message;
                var status = dojo.byId("status");

                if( browser_support ){
                    // Browser is supported. Application error encountered.

                    // TODO - Add proper error handeling.
                    message = "There was an error";
                }
                else{
                    // Browser is unsupported. Notify the user.
                   message = "Your browser does not support geolocation. Attempting to load a default location...";
                }
				
				if (error) {
					console.error(error.message);
					
					switch (error.code) {
						case error.PERMISSION_DENIED:
							message += "<br />Browser has not granted permission to utilize your position information.  Try refreshing the page.";
							break;
						case error.POSITION_UNAVAILABLE:
							message += "<br />Your browser does not support geolocation and a default position has not been provided.";
							break;
						case error.TIMEOUT:
							message += "<br />This is taking too long.  Try refreshing the page.";
							break;
						case error.UNSUPPORTED_FEATURE:
							message += "<br />That feature is not supported by this browser.";
							break;
						default:
							message += "<br />An unknown error has occured.  Please refresh the page.";
							break;
					}
				}else{
					message += "<br /><span class=\"success\">Default location loaded.</span>";
				}
				
                status = dojo.byId('status');
                if( status ){
                    status.innerHTML = message;
                    dojo.addClass(status, "error");
                }
                else{
                    alert(message);
                }
            }

            function metersToMiles(meters){
                return meters * .000621371192;
            }
		</script>
    </body>
</html>
